<!DOCTYPE html>
<html>
<head>
    <title>Annotation App</title>
    <link href="https://fonts.googleapis.com/css2?family=Cedarville+Cursive&family=Indie+Flower&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            height: 100vh;
            overflow: hidden;
            touch-action: none;
        }

        .toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #333;
            padding: 10px;
            display: flex;
            gap: 15px;
            z-index: 1000;
        }

        .tool-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px 15px;
            position: relative;
        }

        .canvas-container {
            position: relative;
            height: 100vh;
            margin-top: 50px;
        }

        #mainCanvas {
            position: absolute;
            background: transparent;
            touch-action: none;
        }

        .dot {
            position: absolute;
            background: white;
            width: 2px;
            height: 2px;
            border-radius: 50%;
        }

        .text-element {
            position: absolute;
            color: white;
            font-family: 'Indie Flower', cursive;
            cursor: move;
            max-width: 300px;
            user-select: none;
            touch-action: none;
        }

        .selected {
            outline: 2px dashed white !important;
        }

        .color-palette {
            position: absolute;
            display: none;
            background: #444;
            padding: 10px;
            border-radius: 5px;
            bottom: 60px;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin: 5px;
            cursor: pointer;
            border: 2px solid white;
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <button class="tool-btn" id="penBtn" title="Pen"><i class="fas fa-pen"></i></button>
        <button class="tool-btn" id="textBtn" title="Text"><i class="fas fa-font"></i></button>
        <button class="tool-btn" id="selectBtn" title="Select"><i class="fas fa-vector-square"></i></button>
        <button class="tool-btn" id="eraseBtn" title="Erase"><i class="fas fa-eraser"></i></button>
        <button class="tool-btn" id="saveBtn" title="Save PDF"><i class="fas fa-file-pdf"></i></button>
        <div class="color-palette" id="colorPalette">
            <div class="color-option" style="background: red" data-color="red"></div>
            <div class="color-option" style="background: blue" data-color="blue"></div>
            <div class="color-option" style="background: yellow" data-color="yellow"></div>
            <div class="color-option" style="background: purple" data-color="purple"></div>
            <div class="color-option" style="background: green" data-color="green"></div>
        </div>
    </div>

    <div class="canvas-container">
        <canvas id="mainCanvas"></canvas>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let currentTool = 'pen';
        let currentColor = 'white';
        let elements = [];
        let selectedElement = null;
        let startX, startY;
        let longPressTimer;

        // Initialize canvas
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight - 50;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Create background dots
        function createDots() {
            const container = document.body;
            for(let i = 0; i < 200; i++) {
                const dot = document.createElement('div');
                dot.className = 'dot';
                dot.style.left = Math.random() * window.innerWidth + 'px';
                dot.style.top = (Math.random() * window.innerHeight + 50) + 'px';
                container.appendChild(dot);
            }
        }
        createDots();

        // Tools functionality
        document.querySelectorAll('.tool-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                if(this.id === 'penBtn') return;
                currentTool = this.id.replace('Btn', '');
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Pen tool with color selection
        const penBtn = document.getElementById('penBtn');
        const colorPalette = document.getElementById('colorPalette');

        penBtn.addEventListener('mousedown', startLongPress);
        penBtn.addEventListener('mouseup', endLongPress);
        penBtn.addEventListener('touchstart', startLongPress);
        penBtn.addEventListener('touchend', endLongPress);

        document.querySelectorAll('.color-option').forEach(color => {
            color.addEventListener('click', (e) => {
                currentColor = e.target.dataset.color;
                colorPalette.style.display = 'none';
            });
        });

        function startLongPress(e) {
            e.preventDefault();
            longPressTimer = setTimeout(() => {
                const rect = penBtn.getBoundingClientRect();
                colorPalette.style.left = rect.left + 'px';
                colorPalette.style.display = 'flex';
            }, 500);
        }

        function endLongPress() {
            clearTimeout(longPressTimer);
            if(currentTool !== 'pen') {
                currentTool = 'pen';
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                penBtn.classList.add('active');
            }
        }

        // Drawing functionality
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            startDrawing({ offsetX: touch.clientX, offsetY: touch.clientY - 50 });
        });
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            draw({ offsetX: touch.clientX, offsetY: touch.clientY - 50 });
        });
        canvas.addEventListener('touchend', stopDrawing);

        function startDrawing(e) {
            if(currentTool === 'pen') {
                isDrawing = true;
                ctx.beginPath();
                ctx.moveTo(e.offsetX, e.offsetY);
            }
        }

        function draw(e) {
            if(!isDrawing) return;
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
            ctx.beginPath();
        }

        // Text tool
        canvas.addEventListener('click', addTextElement);
        
        function addTextElement(e) {
            if(currentTool !== 'text') return;
            
            const textarea = document.createElement('textarea');
            textarea.style.position = 'absolute';
            textarea.style.left = e.clientX + 'px';
            textarea.style.top = (e.clientY - 50) + 'px';
            textarea.style.background = 'transparent';
            textarea.style.border = '1px dashed white';
            textarea.style.color = 'white';
            textarea.style.fontFamily = 'Indie Flower, cursive';
            document.body.appendChild(textarea);
            
            textarea.addEventListener('blur', () => {
                createTextElement(textarea.value, parseFloat(textarea.style.left), parseFloat(textarea.style.top));
                document.body.removeChild(textarea);
            });
        }

        function createTextElement(text, x, y) {
            const colors = ['#2196F3', '#4CAF50', '#F44336', '#9C27B0', '#FFEB3B'];
            const wrapper = document.createElement('div');
            wrapper.className = 'text-element';
            wrapper.style.left = x + 'px';
            wrapper.style.top = y + 'px';
            
            text.split(/(\*\*.*?\*\*|\*.*?\*)/g).forEach(part => {
                if(!part) return;
                const span = document.createElement('span');
                
                if(part.startsWith('**') && part.endsWith('**')) {
                    span.textContent = part.slice(2, -2);
                    span.style.fontFamily = 'Cedarville Cursive, cursive';
                    span.style.fontSize = '32px';
                    span.style.display = 'block';
                    span.style.textAlign = 'center';
                    span.style.width = '100%';
                } else if(part.startsWith('*') && part.endsWith('*')) {
                    span.textContent = part.slice(1, -1);
                    span.style.fontSize = '24px';
                } else {
                    span.textContent = part;
                }
                
                span.style.color = colors[Math.floor(Math.random() * colors.length)];
                wrapper.appendChild(span);
            });
            
            document.querySelector('.canvas-container').appendChild(wrapper);
            elements.push(wrapper);
            makeDraggable(wrapper);
        }

        // Select and move functionality
        function makeDraggable(element) {
            let isDragging = false;
            let startX, startY, initialX, initialY;
            
            element.addEventListener('mousedown', startDrag);
            element.addEventListener('touchstart', startDrag);

            function startDrag(e) {
                if(currentTool !== 'select') return;
                e.preventDefault();
                isDragging = true;
                selectedElement = element;
                document.querySelectorAll('.text-element').forEach(el => el.classList.remove('selected'));
                element.classList.add('selected');
                
                if(e.type === 'touchstart') {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                } else {
                    startX = e.clientX;
                    startY = e.clientY;
                }
                
                initialX = element.offsetLeft;
                initialY = element.offsetTop;

                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', stopDrag);
                document.addEventListener('touchmove', drag);
                document.addEventListener('touchend', stopDrag);
            }

            function drag(e) {
                if(!isDragging) return;
                let currentX, currentY;
                
                if(e.type === 'touchmove') {
                    currentX = e.touches[0].clientX;
                    currentY = e.touches[0].clientY;
                } else {
                    currentX = e.clientX;
                    currentY = e.clientY;
                }
                
                const dx = currentX - startX;
                const dy = currentY - startY;
                
                element.style.left = initialX + dx + 'px';
                element.style.top = initialY + dy + 'px';
            }

            function stopDrag() {
                isDragging = false;
                document.removeEventListener('mousemove', drag);
                document.removeEventListener('touchmove', drag);
            }
        }

        // Erase functionality
        document.getElementById('eraseBtn').addEventListener('click', () => {
            currentTool = 'erase';
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            eraseBtn.classList.add('active');
        });

        canvas.addEventListener('mousedown', erase);
        canvas.addEventListener('touchstart', erase);

        function erase(e) {
            if(currentTool !== 'erase') return;
            const x = e.clientX || e.touches[0].clientX;
            const y = (e.clientY || e.touches[0].clientY) - 50;
            
            // Erase canvas content
            ctx.clearRect(x - 15, y - 15, 30, 30);
            
            // Erase text elements
            elements.forEach((element, index) => {
                const rect = element.getBoundingClientRect();
                if(x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                    element.remove();
                    elements.splice(index, 1);
                }
            });
        }

        // Save as PDF
        document.getElementById('saveBtn').addEventListener('click', () => {
            html2canvas(document.querySelector('.canvas-container')).then(canvas => {
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgData = canvas.toDataURL('image/png');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const imgWidth = pageWidth;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                pdf.save('annotation.pdf');
            });
        });
    </script>
</body>
</html>
